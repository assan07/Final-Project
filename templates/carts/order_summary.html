<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Checkout Page</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/order_summary.css') }}"
    />
    
  </head>
  <body>
    {% extends "main/navbar1.html" %}
    {% block content %} 
    <div class="container page-summary">
      <h4>Keranjang Belanja</h4>
      <form>
        <div class="row">
          <!-- Bagian kiri: Daftar Barang -->
          <div class="col-md-7">
            {% for item in cart_items %}
            <div
              class="form-check d-flex align-items-start mb-3"
              data-item-id="{{ item.id }}"
            >
              <input
                class="form-check-input me-3"
                type="checkbox"
                name="items[]"
                value="{{ item.id }}"
                id="{{ item.id }}"
              />
              <label class="form-check-label w-100" for="{{ item.id }}">
                <div class="d-flex align-items-center">
                  <div class="img-placeholder me-3"></div>
                  <div>
                    <p class="mb-1 fw-bold">{{ item.brand }}</p>
                    <p class="mb-0 text-muted">
                      RP.
                      <span class="item-total"
                        >{{ "{:,.0f}".format(item.harga * item.quantity)
                        }}</span
                      >
                    </p>
                    <div class="d-flex align-items-center mt-2">
                      <button
                        class="btn btn-outline-danger btn-sm me-2 btn-decrease"
                        type="button"
                      >
                        -
                      </button>
                      <input
                        type="text"
                        class="form-control text-center quantity-input"
                        value="{{ item.quantity }}"
                        style="width: 50px"
                      />
                      <button
                        class="btn btn-outline-success btn-sm ms-2 btn-increase"
                        type="button"
                      >
                        +
                      </button>
                    </div>
                  </div>
                </div>
              </label>
            </div>
            {% endfor %}
          </div>

          <!-- Bagian kanan: Ringkasan -->
          <div class="col-md-5">
            <div class="mb-3">
              <textarea
                class="form-control form-control-sm"
                id="alamat"
                rows="3"
                placeholder="Alamat anda"
              ></textarea>
            </div>
            <div class="bg-light p-3 rounded shadow">
              <h6 class="fw-bold">Ringkasan Belanja</h6>
              <div class="d-flex justify-content-between">
                <p class="mb-1">Total Harga</p>
                <p class="mb-1 fw-bold" id="total-harga">
                  Rp. {{ "{:,.0f}".format(total_price) }}
                </p>
              </div>
              <button type="submit" class="btn btn-dark w-100">Beli</button>
            </div>
          </div>
        </div>
      </form>
    </div>
    {% endblock %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).ready(function () {
        // Function to update total price
        function updateTotalPrice() {
          let totalPrice = 0;
          $(".form-check").each(function () {
            const itemTotal = parseFloat(
              $(this).find(".item-total").text().replace(/,/g, "")
            );
            totalPrice += itemTotal || 0;
          });
          $("#total-harga").text("Rp. " + totalPrice.toLocaleString());
        }

        // Function to update item quantity via AJAX
        function updateItemQuantity(itemId, quantity) {
          $.ajax({
            url: "/update-cart",
            method: "POST",
            contentType: "application/json",
            data: JSON.stringify({ item_id: itemId, quantity: quantity }),
            success: function (response) {
              const itemRow = $(`.form-check[data-item-id="${itemId}"]`);
              const itemTotal = response.updated_price;
              itemRow.find(".item-total").text(itemTotal.toLocaleString());
              updateTotalPrice();
            },
            error: function (xhr) {
              alert(xhr.responseJSON.message);
            },
          });
        }

        // Decrease quantity
        $(".btn-decrease").click(function () {
          const itemRow = $(this).closest(".form-check");
          const itemId = itemRow.data("item-id");
          let quantity = parseInt(itemRow.find(".quantity-input").val());
          if (quantity > 1) {
            quantity--;
            itemRow.find(".quantity-input").val(quantity);
            updateItemQuantity(itemId, quantity);
          }
        });

        // Increase quantity
        $(".btn-increase").click(function () {
          const itemRow = $(this).closest(".form-check");
          const itemId = itemRow.data("item-id");
          let quantity = parseInt(itemRow.find(".quantity-input").val());
          quantity++;
          itemRow.find(".quantity-input").val(quantity);
          updateItemQuantity(itemId, quantity);
        });

        // Direct quantity input change
        $(".quantity-input").on("change", function () {
          const itemRow = $(this).closest(".form-check");
          const itemId = itemRow.data("item-id");
          let quantity = parseInt($(this).val());
          if (quantity > 0) {
            updateItemQuantity(itemId, quantity);
          } else {
            $(this).val(1); // Reset to 1 if invalid value
          }
        });
      });
    </script>
  </body>
</html>
