<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="icon"
      href="{{ url_for('static', filename='images/icon/logo-brand.png') }}"
      type="image/x-icon"
    />
    <link
      rel="shortcut icon"
      href="{{ url_for('static', filename='images/icon/logo-brand.png') }}"
      type="image/x-icon"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile Management</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/order_history.css') }}"
    />
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <!-- Navbar -->
    <header>
      <div class="container w-75">
        <nav class="nav fixed-top nav-pills" aria-label="Main navigation">
          <a
            href="/"
            class="logo d-flex align-items-center mb-3 mb-md-0 me-md-auto link-body-emphasis text-decoration-none"
          >
            <img
              width="56px"
              height="56px"
              src="{{ url_for('static', filename='images/icon/logo-brand.png') }}"
              alt="Logo brand"
              style="margin-left: 40px; margin-right: 10px"
            />
            <img
              width="160"
              height="40"
              src="{{ url_for('static', filename='images/icon/logo-title.png') }}"
              alt="Logo title"
            />
          </a>
          <ul class="link-href">
            <li class="nav-item"><a href="/" class="nav-link">Home</a></li>
            <li class="nav-item">
              <a href="/#about" class="nav-link">About</a>
            </li>
            <li class="nav-item">
              <a href="/products/product_lists" class="nav-link">Product</a>
            </li>

            <div class="icon-user">
              {% if profile_pic %}
              <a href="/accounts/users/profile"
                ><img
                  src="{{ profile_pic }}"
                  alt="Profile Picture"
                  class="img-thumbnail"
              /></a>
              {% else %}
              <i class="fa-solid fa-user fa-xl mt-3"></i>
              {% endif %}
              <div class="profile-item">
                <a
                  href="/accounts/users/profile"
                  id="profile-link"
                  class="nav-link profile_menu navbar-usernm"
                  >{{ full_name }}</a
                >
              </div>
            </div>
          </ul>
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <div class="profile-container">
      <div class="row profile-box p-4">
        <!-- side bar -->
        <div class="side-bar col-md-3 text-start">
          <div class="profile-info d-flex align-items-center gap-4">
            <div class="image-profile">
              {% if profile_pic %}
              <img
                src="{{ profile_pic }}"
                alt="Profile Picture"
                class="img-thumbnail"
              />
              {% else %}
              <a href="/accounts/users/profile"
                ><img
                  src="{{ url_for('static', filename='images/profile_pics/default_profile.png') }}"
                  alt="Profile Picture"
                  class="img-thumbnail"
              /></a>
              {% endif %}
            </div>
            <div class="profile-name">
              <p>{{ full_name }}</p>
              <p>{{ email }}</p>
            </div>
          </div>
          <div class="sidebar-menu d-flex flex-column">
            <a href="/accounts/users/profile"
              ><i class="fa-solid fa-user-pen"></i>Akun anda</a
            >
            <a href="/carts/order_summary"
              ><i class="fa-solid fa-cart-arrow-down"></i>Keranjang anda</a
            >
            <a href="/carts/order_history"
              ><i class="fa-solid fa-clock-rotate-left"></i>Riwayat</a
            >
            <a href="/accounts/users/edit_password"
              ><i class="fas fa-key"></i>Edit password</a
            >
            <a href="/accounts/users/logout"
              ><i class="fa-solid fa-right-from-bracket"></i>Log Out</a
            >
          </div>
        </div>

        <!-- Riwayat Pembelian -->
        <div class="history-cont my-5 col-md-6 mt-5">
          <div class="card bg-light p-3">
            <!-- Product List -->
            <div class="container">
              {% for order in orders %}
              <div class="order-items">
                {% for item in order.get('items', []) %}
                <div class="row mb-3 align-items-center">
                  <div class="col-2">
                    <img
                      src="{{ url_for('static', filename='images/gambar_barang/' + item.get('gambar_barang', 'placeholder.png')) }}"
                      class="img-fluid rounded"
                      alt="{{ item.get('nama_barang', 'Product Image') }}"
                    />
                  </div>
                  <div class="col-8">
                    <h5>{{ item.get('nama_barang', 'Nama Produk') }}</h5>
                    <p>Quantity: {{ item.get('quantity', 0) }}</p>
                    <p>Total: Rp. {{ item.get('subtotal', 0) }}</p>
                  </div>
                  <div class="col-2 button-fiture">
                    <!-- Beli Lagi Button -->
                    <a
                      href="{{ url_for('product_details', product_id=item.get('product_id')) }}"
                      class="btn btn-success mb-2"
                    >
                      <i class="fa-solid fa-cart-arrow-down"></i> Beli Lagi
                    </a>

                    <div class="item-row">
                      <span>Nama Produk: {{ item['nama'] }}</span>
                      <button
                        class="btn btn-danger remove-item-btn"
                        data-order-id="{{ order['_id'] }}"
                        data-product-id="{{ item['product_id'] }}"
                      >
                        <i class="fa-solid fa-trash-arrow-up"></i> Hapus
                      </button>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).on("click", ".remove-item-btn", function (e) {
        e.preventDefault(); // Mencegah reload halaman

        const $button = $(this);
        const orderId = $button.data("order-id");
        const productId = $button.data("product-id");

        if (!orderId || !productId) {
          alert("Order ID atau Product ID tidak valid");
          return;
        }

        // Konfirmasi sebelum menghapus
        //if (!confirm("Apakah Anda yakin ingin menghapus item ini?")) {
         // return;
        //}

        $.ajax({
          url: "/remove-from-order",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({ order_id: orderId, product_id: productId }),
          success: function (response) {
            alert(response.message);

            // Hapus elemen item dari DOM
            $button.closest(".item-row").remove();
            location.reload()

            // Tambahkan logika tambahan jika diperlukan, misalnya memperbarui total harga
          },
          error: function (xhr) {
            alert(
              xhr.responseJSON.message ||
                "Terjadi kesalahan saat menghapus item"
            );
          },
        });
      });
    </script>
  </body>
</html>
