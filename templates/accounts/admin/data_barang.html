<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin Barang</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/data_user.css') }}" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>
    <!-- Navbar -->
    <header>
        <nav class="nav-custom d-flex align-items-center">
            <a href="/" class="d-flex mx-3 align-items-center mb-3 mb-md-0 me-md-auto text-decoration-none">
                <img class="bi me-2" width="40" height="40" src="{{ url_for('static', filename='images/icon/logo-brand.png') }}" alt="Logo brand" />
                <img class="fs-4 bi me-2" width="160" height="40" src="{{ url_for('static', filename='images/icon/logo-title.png') }}" alt="Logo title" />
            </a>
            <ul class="nav">
                <li class="nav-item">
                    <a href="/accounts/admin/data_barang" class="nav-link">Data Barang</a>
                </li>
                <li class="nav-item">
                    <a href="/accounts/admin/data_user" class="nav-link">Data User</a>
                </li>
            </ul>
        </nav>
    </header>

    <!-- Content -->
    <div class="container mt-4">
        <div class="card mt-4">
            <div class="card-body">
                <h2 class="card-title">DATA BARANG</h2>
                <!-- Search Bar -->
                <div class="d-flex justify-content-end mb-3">
                    <input type="text" class="form-control w-25 me-2" placeholder="Search">
                    <button class="btn btn-dark">Search</button>
                    <button id="tambahBtn" type="button" class="btn btn-danger mx-2">Tambah Barang</button>
                </div>

                <!-- Table -->
                <div class="table-responsive">
                    <table class="table table-bordered text-center">
                        <thead class="table-secondary">
                            <tr>
                                <th>No.</th>
                                <th>Kategori</th>
                                <th>Brand</th>
                                <th>Netto</th>
                                <th>Warna</th>
                                <th>Harga</th>
                                <th>Stok</th>
                                <th>Image</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="barangTableBody">
                            {% for barang in barang_data %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ barang.kategori }}</td>
                                <td>{{ barang.brand }}</td>
                                <td>{{ barang.netto }}</td>
                                <td>{{ barang.warna }}</td>
                                <td>{{ barang.harga }}</td>
                                <td>{{ barang.stock }}</td>
                                <td>
                                    {% if barang.foto %}
                                    <img src="{{ url_for('static', filename='images/uploads/' + barang.foto) }}" alt="Foto Barang" width="50"> {% else %} No Image {% endif %}
                                </td>

                                <td>
                                    <button class="btn btn-danger btn-sm delete-btn" type="button" data-id="{{ barang._id }}">
                                        <i class="fa fa-trash"></i> Delete
                                    </button>
                                    <!-- Button Edit -->
                                    <button class="btn btn-danger btn-sm edit-btn" type="button" data-id="{{ barang._id }}" data-kategori="{{ barang.kategori }}" data-brand="{{ barang.brand }}" data-netto="{{ barang.netto }}" data-warna="{{ barang.warna }}" data-harga="{{ barang.harga }}"
                                        data-stock="{{ barang.stock }}" data-foto="{{ barang.foto }}">
                                        <i class="fa fa-edit"></i> Edit
                                    </button>

                                </td>

                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- form tambah barang -->
        <div id="input-box" style="display: none;">
            <div class="row g-2 mt-5 border border-2 p-4">
                <div class="col-md-4">
                    <label for="inputState" class="form-label">Kategori</label>
                    <select id="inputState" class="form-select">
                        <option selected>Choose...</option>
                        <option>CAT</option>
                        <option>TINNER</option>
                        <option>AKSESORIS PVC</option>
                    </select>
                </div>
                <div class="mb-2 col-md-4">
                    <label for="InputBrand" class="form-label">Brand</label>
                    <input type="text" class="form-control" id="brand" placeholder="Brand Name">
                </div>
                <div class="col-md-4">
                    <label for="InputNetto" class="form-label">Netto</label>
                    <input type="text" class="form-control" id="netto" placeholder="Netto Product">
                </div>
                <div class="col-md-4">
                    <label for="inputWarna" class="form-label">Warna</label>
                    <input type="text" class="form-control" id="warna" placeholder="Warna Product">
                </div>
                <div class="col-md-4">
                    <label for="inputHarga" class="form-label">Harga</label>
                    <input type="text" class="form-control" id="harga" placeholder="Harga Product">
                </div>
                <div class="col-md-4">
                    <label for="inputStock" class="form-label">Stock</label>
                    <input type="text" class="form-control" id="stock" placeholder="Stock Product">
                </div>
                <div class="col-md-12">
                    <label for="formFileMultiple" class="form-label">Foto Product</label>
                    <input class="form-control" type="file" id="foto" multiple>
                </div>
                <div class="mt-4 col-12">
                    <button id="submitSimpanBarang" class="btn btn-primary">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Tampilkan input form
        document.getElementById("tambahBtn").addEventListener("click", function() {
            document.getElementById("input-box").style.display = "block";
        });

        // Menambahkan barang baru ke dalam database
        document.getElementById("submitSimpanBarang").addEventListener("click", function() {
            var kategori = document.getElementById("inputState").value;
            var brand = document.getElementById("brand").value;
            var netto = document.getElementById("netto").value;
            var warna = document.getElementById("warna").value;
            var harga = document.getElementById("harga").value;
            var stock = document.getElementById("stock").value;
            var foto = document.getElementById("foto").files[0]; // Ambil file foto

            if (!kategori || !brand || !netto || !warna || !harga || !stock) {
                alert("Semua kolom harus diisi!");
                return;
            }

            // Buat FormData untuk mengirim data termasuk file gambar
            var formData = new FormData();
            formData.append('kategori', kategori);
            formData.append('brand', brand);
            formData.append('netto', netto);
            formData.append('warna', warna);
            formData.append('harga', harga);
            formData.append('stock', stock);
            if (foto) {
                formData.append('foto', foto);
            }

            // Kirim data menggunakan AJAX
            $.ajax({
                url: '/accounts/admin/data_barang/tambah_barang',
                type: 'POST',
                data: formData,
                processData: false, // Jangan memproses data sebagai string
                contentType: false, // Biarkan jQuery mengatur content type sesuai kebutuhan
                success: function(response) {
                    alert("Barang berhasil disimpan");
                    location.reload();
                },
                error: function() {
                    alert("Terjadi kesalahan. Silakan coba lagi...");
                }
            });
        });


        // Hapus Barang
        $(document).ready(function() {
            // Event listener untuk tombol delete
            $("#barangTableBody").on("click", ".delete-btn", function() {
                const barangId = $(this).data("id");

                // Tampilkan dialog konfirmasi
                const confirmation = confirm("Anda yakin akan menghapus barang ini?");
                if (confirmation) {
                    // Kirim permintaan DELETE menggunakan AJAX
                    $.ajax({
                        url: "/accounts/admin/data_barang/delete_barang",
                        type: "POST",
                        data: {
                            id: barangId
                        },
                        success: function(response) {
                            if (response.status === "success") {
                                alert(response.message);

                                // Hapus baris barang dari tabel
                                $(`#barangTableBody tr:has(td button[data-id='${barangId}'])`).remove();

                                // Perbarui nomor urut secara dinamis
                                $("#barangTableBody tr").each(function(index) {
                                    $(this).find("td:first").text(index + 1);
                                });
                            } else {
                                alert("Gagal menghapus data.");
                            }
                        },
                        error: function() {
                            alert("Terjadi kesalahan pada server.");
                        }
                    });
                }
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
</body>

</html>
