<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Admin Barang</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/data_user.css') }}"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>

  <body>
    <!-- Navbar -->
    <header>
      <nav class="nav-custom d-flex align-items-center">
        <a
          href="/"
          class="d-flex mx-3 align-items-center mb-3 mb-md-0 me-md-auto text-decoration-none"
        >
          <img
            class="bi me-2"
            width="40"
            height="40"
            src="{{ url_for('static', filename='images/icon/logo-brand.png') }}"
            alt="Logo brand"
          />
          <img
            class="fs-4 bi me-2"
            width="160"
            height="40"
            src="{{ url_for('static', filename='images/icon/logo-title.png') }}"
            alt="Logo title"
          />
        </a>
        <ul class="nav">
          <li class="nav-item">
            <a href="/admin/dashboard" class="nav-link">Dashboard</a>
          </li>
        </ul>
      </nav>
    </header>

    <!-- Content -->
    <div class="container mt-4">
      <div class="card mt-4">
        <div class="card-body">
          <h2 class="card-title">DATA BARANG</h2>
          <!-- Search Bar -->
          <div class="d-flex justify-content-end mb-3">
            <input
              type="text"
              class="form-control w-25 me-2"
              placeholder="Search"
            />
            <button class="btn btn-dark">Search</button>
            <button id="tambahBtn" type="button" class="btn btn-danger mx-2">
              Tambah Barang
            </button>
          </div>

          <!-- Table -->
          <div class="table-responsive">
            <table class="table table-bordered text-center">
              <thead class="table-secondary">
                <tr>
                  <th>No.</th>
                  <th>Kategori</th>
                  <th>Brand</th>
                  <th>Netto</th>
                  <th>Warna</th>
                  <th>Harga</th>
                  <th>Stok</th>
                  <th>Image</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody id="barangTableBody">
                {% for barang in barang_data %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ barang.kategori }}</td>
                  <td>{{ barang.brand }}</td>
                  <td>{{ barang.netto }}</td>
                  <td>{{ barang.warna }}</td>
                  <td>{{ barang.harga }}</td>
                  <td>{{ barang.stock }}</td>
                  <td>
                    {% if barang.foto %}
                    <img
                      src="{{ url_for('static', filename='images/uploads/' + barang.foto) }}"
                      alt="Foto Barang"
                      width="50"
                    />
                    {% else %} No Image {% endif %}
                  </td>

                  <td>
                    <button
                      class="btn btn-danger btn-sm delete-btn"
                      type="button"
                      data-id="{{ barang._id }}"
                    >
                      <i class="fa fa-trash"></i> Delete
                    </button>
                    <!-- Button Edit -->
                    <button
                      class="btn btn-danger btn-sm edit-btn"
                      type="button"
                      data-id="{{ barang._id }}"
                      data-kategori="{{ barang.kategori }}"
                      data-brand="{{ barang.brand }}"
                      data-netto="{{ barang.netto }}"
                      data-warna="{{ barang.warna }}"
                      data-harga="{{ barang.harga }}"
                      data-stock="{{ barang.stock }}"
                      data-foto="{{ barang.foto }}"
                    >
                      <i class="fa fa-edit"></i> Edit
                    </button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- form tambah barang -->
      <div id="input-box" style="display: none">
        <div class="row g-2 mt-5 border border-2 p-4">
          <div class="col-md-4">
            <label for="inputState" class="form-label">Kategori</label>
            <select id="inputState" class="form-select">
              <option selected>Choose...</option>
              <option>CAT</option>
              <option>TINNER</option>
              <option>AKSESORIS PVC</option>
            </select>
          </div>
          <div class="mb-2 col-md-4">
            <label for="InputBrand" class="form-label">Brand</label>
            <input
              type="text"
              class="form-control"
              id="brand"
              placeholder="Brand Name"
            />
          </div>
          <div class="col-md-4">
            <label for="InputNetto" class="form-label">Netto</label>
            <input
              type="text"
              class="form-control"
              id="netto"
              placeholder="Netto Product"
            />
          </div>
          <div class="col-md-4">
            <label for="inputWarna" class="form-label">Warna</label>
            <input
              type="text"
              class="form-control"
              id="warna"
              placeholder="Warna Product"
            />
          </div>
          <div class="col-md-4">
            <label for="inputHarga" class="form-label">Harga</label>
            <input
              type="text"
              class="form-control"
              id="harga"
              placeholder="Harga Product"
            />
          </div>
          <div class="col-md-4">
            <label for="inputStock" class="form-label">Stock</label>
            <input
              type="text"
              class="form-control"
              id="stock"
              placeholder="Stock Product"
            />
          </div>
          <div class="col-md-12">
            <label for="formFileMultiple" class="form-label"
              >Foto Product</label
            >
            <input class="form-control" type="file" id="foto" multiple />
          </div>
          <div class="mt-4 col-12">
            <button id="submitSimpanBarang" class="btn btn-primary">
              Simpan
            </button>
          </div>
        </div>
      </div>

      <!-- Form Edit Barang -->
      <div id="edit-box" style="display: none">
        <div class="row g-2 mt-5 border border-2 p-4">
          <div class="col-md-4">
            <label for="editKategori" class="form-label">Kategori</label>
            <select id="editKategori" class="form-select">
              <option selected>Choose...</option>
              <option>CAT</option>
              <option>TINNER</option>
              <option>AKSESORIS PVC</option>
            </select>
          </div>
          <div class="mb-2 col-md-4">
            <label for="editBrand" class="form-label">Brand</label>
            <input
              type="text"
              class="form-control"
              id="editBrand"
              placeholder="Brand Name"
            />
          </div>
          <div class="col-md-4">
            <label for="editNetto" class="form-label">Netto</label>
            <input
              type="text"
              class="form-control"
              id="editNetto"
              placeholder="Netto Product"
            />
          </div>
          <div class="col-md-4">
            <label for="editWarna" class="form-label">Warna</label>
            <input
              type="text"
              class="form-control"
              id="editWarna"
              placeholder="Warna Product"
            />
          </div>
          <div class="col-md-4">
            <label for="editHarga" class="form-label">Harga</label>
            <input
              type="text"
              class="form-control"
              id="editHarga"
              placeholder="Harga Product"
            />
          </div>
          <div class="col-md-4">
            <label for="editStock" class="form-label">Stock</label>
            <input
              type="text"
              class="form-control"
              id="editStock"
              placeholder="Stock Product"
            />
          </div>
          <div class="col-md-12">
            <label for="editFoto" class="form-label">Foto Product</label>
            <input class="form-control" type="file" id="editFoto" />
          </div>
          <div class="mt-4 col-12">
            <button id="submitEditBarang" class="btn btn-primary">
              Simpan Perubahan
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        // Tampilkan input form untuk tambah barang
        $("#tambahBtn").on("click", function () {
          $("#input-box").show(); // Menampilkan form tambah barang
        });

        // Menambahkan barang baru ke dalam database
        $("#submitSimpanBarang").on("click", function (e) {
          e.preventDefault();

          const formData = new FormData();
          formData.append("kategori", $("#inputState").val());
          formData.append("brand", $("#brand").val());
          formData.append("netto", $("#netto").val());
          formData.append("warna", $("#warna").val());
          formData.append("harga", $("#harga").val());
          formData.append("stock", $("#stock").val());
          const foto = $("#foto")[0].files[0];
          if (foto) formData.append("foto", foto);

          if (
            !$("#inputState").val() ||
            !$("#brand").val() ||
            !$("#netto").val() ||
            !$("#warna").val() ||
            !$("#harga").val() ||
            !$("#stock").val()
          ) {
            alert("Semua kolom harus diisi!");
            return;
          }

          $.ajax({
            url: "/accounts/admin/data_barang/tambah_barang",
            type: "POST",
            data: formData,
            processData: false, // Jangan memproses data sebagai string
            contentType: false, // Konten otomatis disesuaikan oleh browser
            success: function (response) {
              alert("Barang berhasil disimpan!");
              location.reload(); // Muat ulang halaman setelah berhasil
            },
            error: function () {
              alert("Terjadi kesalahan. Silakan coba lagi...");
            },
          });
        });

        // Hapus Barang
        $("#barangTableBody").on("click", ".delete-btn", function () {
          const barangId = $(this).data("id");

          if (confirm("Anda yakin akan menghapus barang ini?")) {
            $.ajax({
              url: "/accounts/admin/data_barang/delete_barang",
              type: "POST",
              data: { id: barangId },
              success: function (response) {
                if (response.status === "success") {
                  alert(response.message);

                  // Hapus baris barang dari tabel
                  $(
                    `#barangTableBody tr:has(td button[data-id='${barangId}'])`
                  ).remove();

                  // Perbarui nomor urut secara dinamis
                  $("#barangTableBody tr").each(function (index) {
                    $(this)
                      .find("td:first")
                      .text(index + 1);
                  });
                } else {
                  alert("Gagal menghapus data.");
                }
              },
              error: function () {
                alert("Terjadi kesalahan pada server.");
              },
            });
          }
        });

        // Menangani klik tombol Edit
        $("#barangTableBody").on("click", ".edit-btn", function () {
          const id = $(this).data("id");
          const kategori = $(this).data("kategori");
          const brand = $(this).data("brand");
          const netto = $(this).data("netto");
          const warna = $(this).data("warna");
          const harga = $(this).data("harga");
          const stock = $(this).data("stock");

          // Isi form dengan data yang diambil
          $("#editKategori").val(kategori);
          $("#editBrand").val(brand);
          $("#editNetto").val(netto);
          $("#editWarna").val(warna);
          $("#editHarga").val(harga);
          $("#editStock").val(stock);

          // Tampilkan form edit
          $("#edit-box").show();

          // Menangani pengiriman data edit ke server
          $("#submitEditBarang")
            .off("click")
            .on("click", function (e) {
              e.preventDefault();

              const formData = new FormData();
              formData.append("id", id);
              formData.append("kategori", $("#editKategori").val());
              formData.append("brand", $("#editBrand").val());
              formData.append("netto", $("#editNetto").val());
              formData.append("warna", $("#editWarna").val());
              formData.append("harga", $("#editHarga").val());
              formData.append("stock", $("#editStock").val());
              const updatedFoto = $("#editFoto")[0].files[0];
              if (updatedFoto) formData.append("foto", updatedFoto);

              $.ajax({
                url: "/accounts/admin/data_barang/edit_barang",
                method: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                  if (response.status === "success") {
                    alert("Barang berhasil diperbarui!");
                    location.reload(); // Reload halaman setelah berhasil
                  } else {
                    alert("Terjadi kesalahan saat memperbarui barang.");
                  }
                },
                error: function () {
                  alert("Terjadi kesalahan saat mengirim data.");
                },
              });
            });
        });
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
  </body>
</html>
